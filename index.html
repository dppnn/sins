<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<title>SINS ‚Äî –ê–Ω–∫–µ—Ç–∞</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #171717;
    --surface: #222222;
    --border: #4D4D4D;
    --accent: #F25623;
    --gold: #F25623;
    --text: #DEDEDE;
    --muted: #4D4D4D;
    --card: #1f1f1f;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Cormorant Garamond', serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse at 20% 20%, rgba(242,86,35,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 80%, rgba(242,86,35,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 480px;
    margin: 0 auto;
    padding: 0 0 48px;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  .header {
    text-align: center;
    padding: 52px 24px 36px;
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  .header::after {
    content: '‚ú¶';
    position: absolute;
    bottom: -13px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg);
    padding: 0 14px;
    color: var(--gold);
    font-size: 18px;
  }
  .logo {
    font-family: 'Playfair Display', serif;
    font-size: clamp(52px, 18vw, 80px);
    font-weight: 700;
    letter-spacing: 0.22em;
    color: var(--accent);
    text-transform: uppercase;
    line-height: 1;
  }
  .tagline {
    margin-top: 10px;
    font-style: italic;
    font-size: 14px;
    color: var(--muted);
    letter-spacing: 0.06em;
  }

  /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
  .section { padding: 36px 20px 0; }
  .section-label { font-size: 10px; letter-spacing: 0.28em; text-transform: uppercase; color: var(--gold); margin-bottom: 16px; }
  .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
  .input-row.single { grid-template-columns: 1fr; }
  .field { display: flex; flex-direction: column; gap: 6px; }
  .field label { font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--muted); }
  .field input, .field select {
    background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: 'Cormorant Garamond', serif;
    font-size: 16px; padding: 12px 14px; border-radius: 2px;
    outline: none; transition: border-color 0.2s; -webkit-appearance: none;
  }
  .field input:focus, .field select:focus { border-color: var(--accent); }
  .field input::placeholder { color: var(--muted); }
  .field select option { background: #1f1f1f; }

  /* ‚îÄ‚îÄ DRAG LIST ‚îÄ‚îÄ */
  .ranking-section { padding: 36px 20px 0; }
  .ranking-title { font-size: 10px; letter-spacing: 0.28em; text-transform: uppercase; color: var(--gold); margin-bottom: 6px; }
  .ranking-hint { font-size: 13px; font-style: italic; color: var(--muted); margin-bottom: 20px; line-height: 1.5; }
  .sin-list { display: flex; flex-direction: column; gap: 8px; list-style: none; }
  .sin-item {
    background: var(--card); border: 1px solid var(--border); border-radius: 2px;
    display: flex; align-items: center; gap: 14px; padding: 13px 16px;
    cursor: grab; touch-action: none;
    transition: border-color 0.2s, background 0.2s, transform 0.12s;
    user-select: none;
  }
  .sin-item:active { cursor: grabbing; }
  .sin-item.dragging { opacity: 0.35; border-color: var(--accent); }
  .sin-item.drag-over { border-color: var(--gold); background: #262626; transform: scale(1.012); }
  .sin-rank { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; color: var(--accent); min-width: 26px; text-align: center; line-height: 1; }
  .sin-emoji { font-size: 26px; line-height: 1; }
  .sin-info { flex: 1; }
  .sin-name { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: var(--text); letter-spacing: 0.02em; }
  .sin-desc { font-size: 12px; font-style: italic; color: var(--muted); margin-top: 2px; }
  .drag-handle { color: #555555; font-size: 20px; padding: 0 2px; }

  /* ‚îÄ‚îÄ SLIDERS ‚îÄ‚îÄ */
  .intensity-section { padding: 28px 20px 0; }
  .intensity-label { font-size: 10px; letter-spacing: 0.28em; text-transform: uppercase; color: var(--gold); margin-bottom: 6px; }
  .intensity-sub { font-size: 13px; font-style: italic; color: var(--muted); margin-bottom: 18px; }
  .slider-row { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  .slider-sin-name { font-size: 13px; min-width: 96px; color: var(--text); }
  input[type=range] {
    flex: 1; -webkit-appearance: none; appearance: none;
    height: 3px; background: var(--border); border-radius: 2px; outline: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
    background: var(--accent); cursor: pointer; border: 2px solid var(--bg);
  }
  .slider-val { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; color: var(--accent); min-width: 22px; text-align: right; }

  /* ‚îÄ‚îÄ MOTTO ‚îÄ‚îÄ */
  .motto-section { padding: 28px 20px 0; }
  .motto-label { font-size: 10px; letter-spacing: 0.28em; text-transform: uppercase; color: var(--gold); margin-bottom: 6px; }
  .motto-sub { font-size: 13px; font-style: italic; color: var(--muted); margin-bottom: 14px; }
  textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: 'Cormorant Garamond', serif;
    font-size: 16px; font-style: italic; padding: 14px; border-radius: 2px;
    outline: none; resize: none; transition: border-color 0.2s; line-height: 1.5;
  }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--muted); }

  /* ‚îÄ‚îÄ SAVE AREA ‚îÄ‚îÄ */
  .save-section { padding: 36px 20px 0; }
  .btn-save {
    width: 100%; padding: 18px;
    background: var(--accent); color: #fff;
    font-family: 'Playfair Display', serif; font-size: 13px; letter-spacing: 0.2em;
    text-transform: uppercase; border: none; border-radius: 2px; cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }
  .btn-save:hover { background: #a8253b; }
  .btn-save:active { transform: scale(0.98); }
  .btn-save:disabled { opacity: 0.6; cursor: not-allowed; }

  .screenshot-hint {
    margin-top: 14px;
    text-align: center;
    font-size: 13px;
    font-style: italic;
    color: var(--muted);
    line-height: 1.7;
  }
  .screenshot-hint a {
    color: var(--gold);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
  }
  .screenshot-hint a:hover { color: var(--text); }

  /* ‚îÄ‚îÄ SCREENSHOT OVERLAY ‚îÄ‚îÄ */
  #screenshot-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.92);
    z-index: 900;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 16px;
    backdrop-filter: blur(6px);
  }
  #screenshot-overlay.active { display: flex; }

  .overlay-hint {
    font-size: 14px;
    font-style: italic;
    color: var(--gold);
    margin-bottom: 18px;
    text-align: center;
    letter-spacing: 0.04em;
    line-height: 1.5;
  }

  /* iPhone 17 screen: 393pt wide √ó 852pt tall.
     2/3 height ‚âà 568pt. We target ~320px wide card that fits on any phone. */
  #screenshot-card {
    width: min(320px, 90vw);
    background: #171717;
    border: 1px solid #4D4D4D;
    border-radius: 6px;
    padding: 26px 22px 22px;
    position: relative;
    overflow: hidden;
    max-height: 75vh;
    overflow-y: auto;
  }
  #screenshot-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 25% 15%, rgba(242,86,35,0.12) 0%, transparent 65%);
    pointer-events: none;
  }

  .sc-logo { font-family: 'Playfair Display', serif; font-size: 30px; font-weight: 700; color: #F25623; letter-spacing: 0.22em; text-align: center; line-height: 1; }
  .sc-tagline { text-align: center; font-size: 11px; font-style: italic; color: #888888; margin-top: 4px; letter-spacing: 0.05em; }
  .sc-divider { height: 1px; background: #4D4D4D; margin: 14px 0; position: relative; }
  .sc-divider::after { content: '‚ú¶'; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); background: #171717; padding: 0 8px; font-size: 10px; color: #F25623; }
  .sc-name { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; text-align: center; color: #DEDEDE; line-height: 1.2; }
  .sc-meta { text-align: center; font-size: 12px; font-style: italic; color: #888888; margin-top: 3px; margin-bottom: 14px; }
  .sc-section-title { font-size: 9px; letter-spacing: 0.25em; text-transform: uppercase; color: #F25623; margin-bottom: 10px; }
  .sc-sin-row {
    display: flex; align-items: center; gap: 9px;
    margin-bottom: 7px; padding: 8px 10px;
    background: #1f1f1f; border-left: 2px solid #4D4D4D;
  }
  .sc-sin-row.r1 { border-left-color: #F25623; }
  .sc-sin-row.r2 { border-left-color: #c04018; }
  .sc-sin-row.r3 { border-left-color: #8a2e10; }
  .sc-rank { font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 700; color: #F25623; min-width: 18px; }
  .sc-emoji { font-size: 17px; line-height: 1; }
  .sc-sname { font-family: 'Playfair Display', serif; font-size: 13px; color: #DEDEDE; flex: 1; }
  .sc-bar-wrap { width: 40px; height: 3px; background: #4D4D4D; border-radius: 2px; flex-shrink: 0; }
  .sc-bar { height: 100%; background: #F25623; border-radius: 2px; }
  .sc-bar-num { font-size: 11px; color: #888888; min-width: 14px; text-align: right; }
  .sc-motto { margin-top: 12px; padding: 10px 12px; border: 1px solid #4D4D4D; font-size: 12px; font-style: italic; color: #888888; text-align: center; line-height: 1.5; }
  .sc-footer { margin-top: 14px; text-align: center; font-size: 9px; letter-spacing: 0.18em; color: #4D4D4D; text-transform: uppercase; }

  .overlay-close {
    margin-top: 18px;
    background: none; border: 1px solid #4D4D4D; color: #888888;
    font-family: 'Cormorant Garamond', serif; font-size: 13px;
    letter-spacing: 0.1em; padding: 10px 32px; cursor: pointer;
    border-radius: 2px; transition: border-color 0.2s, color 0.2s;
  }
  .overlay-close:hover { border-color: var(--muted); color: var(--text); }

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast {
    position: fixed; bottom: 28px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: var(--surface); border: 1px solid var(--gold);
    color: var(--gold); font-family: 'Cormorant Garamond', serif;
    font-size: 14px; letter-spacing: 0.1em; padding: 12px 24px;
    border-radius: 2px; transition: transform 0.3s ease;
    z-index: 2000; white-space: nowrap; max-width: 90vw; text-align: center;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* ‚îÄ‚îÄ ARCHETYPE ‚îÄ‚îÄ */
  .archetype-section { padding: 36px 20px 0; }
  .arch-label { font-size: 10px; letter-spacing: 0.28em; text-transform: uppercase; color: var(--gold); margin-bottom: 16px; }

  .arch-card {
    border: 1px solid var(--border);
    background: var(--card);
    padding: 28px 24px;
    text-align: center;
    position: relative;
    overflow: hidden;
    animation: archReveal 0.6s ease forwards;
  }
  .arch-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(242,86,35,0.12) 0%, transparent 70%);
    pointer-events: none;
  }
  @keyframes archReveal {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .arch-symbol {
    font-size: 52px;
    line-height: 1;
    margin-bottom: 12px;
    filter: drop-shadow(0 0 16px rgba(242,86,35,0.5));
    animation: pulse 3s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { filter: drop-shadow(0 0 12px rgba(242,86,35,0.4)); }
    50%       { filter: drop-shadow(0 0 24px rgba(242,86,35,0.8)); }
  }

  .arch-name {
    font-family: 'Playfair Display', serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin-bottom: 14px;
  }
  .arch-desc {
    font-size: 15px;
    font-style: italic;
    color: var(--text);
    line-height: 1.7;
    margin-bottom: 16px;
    opacity: 0.85;
  }
  .arch-attracts {
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    border-top: 1px solid var(--border);
    padding-top: 14px;
    margin-top: 4px;
  }
  .arch-attracts span { color: var(--accent); }

  .btn-reveal {
    width: 100%; padding: 18px;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Playfair Display', serif; font-size: 13px; letter-spacing: 0.2em;
    text-transform: uppercase; border-radius: 2px; cursor: pointer;
    transition: background 0.2s, color 0.2s, transform 0.1s;
    margin-bottom: 12px;
  }
  .btn-reveal:hover { background: var(--accent); color: #fff; }
  .btn-reveal:active { transform: scale(0.98); }

  /* sc archetype */
  .sc-arch {
    margin-top: 12px;
    padding: 12px;
    background: #1f1f1f;
    border-left: 3px solid #F25623;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .sc-arch-sym { font-size: 22px; }
  .sc-arch-info { flex: 1; }
  .sc-arch-label { font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: #888; margin-bottom: 2px; }
  .sc-arch-name { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; color: #F25623; }

  /* ‚îÄ‚îÄ FEATURE 4: –ü–û–ö–ê–Ø–ù–ò–ï ‚îÄ‚îÄ */
  .penance-section { padding: 36px 20px 0; }
  .penance-label { font-size: 10px; letter-spacing: 0.28em; text-transform: uppercase; color: var(--gold); margin-bottom: 6px; }
  .penance-sub { font-size: 13px; font-style: italic; color: var(--muted); margin-bottom: 20px; line-height: 1.5; }

  .penance-card {
    border: 1px solid var(--border); background: var(--card);
    padding: 24px 20px; border-radius: 2px; position: relative; overflow: hidden;
  }
  .penance-card::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 110%, rgba(242,86,35,0.08) 0%, transparent 65%);
    pointer-events: none;
  }

  /* Sin selection */
  .penance-sin-grid { display: flex; flex-direction: column; gap: 8px; margin-bottom: 0; }
  .penance-sin-opt {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 14px; border: 1px solid var(--border); border-radius: 2px;
    cursor: pointer; transition: all 0.18s; background: var(--surface);
  }
  .penance-sin-opt:hover { border-color: var(--accent); }
  .penance-sin-opt.selected { border-color: var(--accent); background: rgba(242,86,35,0.07); }
  .p-emoji { font-size: 22px; }
  .p-name { font-family: 'Playfair Display', serif; font-size: 15px; color: var(--text); flex: 1; }
  .p-hint { font-size: 11px; font-style: italic; color: var(--muted); }
  .p-dot { width: 14px; height: 14px; border-radius: 50%; border: 1.5px solid var(--border); flex-shrink: 0; transition: all 0.18s; }
  .penance-sin-opt.selected .p-dot { border-color: var(--accent); background: var(--accent); }

  /* Text field + button ‚Äî appear after selection */
  .penance-confess {
    display: none; margin-top: 18px;
    animation: fadeUp 0.3s ease forwards;
  }
  .penance-confess.visible { display: block; }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .penance-confess-label {
    font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase;
    color: var(--gold); margin-bottom: 8px; display: block;
  }
  .penance-confess-sin-name {
    font-family: 'Playfair Display', serif; font-size: 18px; font-weight: 700;
    color: var(--accent); margin-bottom: 4px;
  }
  .penance-confess-prompt {
    font-size: 13px; font-style: italic; color: var(--muted);
    margin-bottom: 14px; line-height: 1.5;
  }
  .penance-textarea {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    color: var(--text); font-family: 'Cormorant Garamond', serif;
    font-size: 15px; font-style: italic; padding: 14px; border-radius: 2px;
    outline: none; resize: none; transition: border-color 0.2s; line-height: 1.6;
    margin-bottom: 14px;
  }
  .penance-textarea:focus { border-color: var(--accent); }
  .penance-textarea::placeholder { color: var(--muted); }

  .btn-penance {
    width: 100%; padding: 16px;
    background: var(--accent); color: #fff;
    font-family: 'Playfair Display', serif; font-size: 13px; letter-spacing: 0.2em;
    text-transform: uppercase; border: none; border-radius: 2px; cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }
  .btn-penance:hover { background: #c04018; }
  .btn-penance:active { transform: scale(0.98); }
  .btn-penance:disabled { opacity: 0.6; cursor: not-allowed; }

  /* Penance result overlay */
  #penance-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.93); z-index: 950;
    flex-direction: column; align-items: center; justify-content: center;
    padding: 20px; backdrop-filter: blur(6px);
  }
  #penance-overlay.active { display: flex; }
  .penance-overlay-hint {
    font-size: 13px; font-style: italic; color: var(--gold);
    margin-bottom: 18px; text-align: center; letter-spacing: 0.04em;
  }
  #penance-card {
    width: min(320px, 90vw);
    background: #171717; border: 1px solid #4D4D4D; border-radius: 6px;
    padding: 32px 24px 28px; position: relative; overflow: hidden;
    max-height: 80vh; overflow-y: auto;
  }
  #penance-card::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(242,86,35,0.14) 0%, transparent 65%);
    pointer-events: none;
  }
  .pc-logo { font-family: 'Playfair Display', serif; font-size: 28px; font-weight: 700; color: #F25623; letter-spacing: 0.22em; text-align: center; }
  .pc-rule { height: 1px; background: #4D4D4D; margin: 14px 0; position: relative; }
  .pc-rule::after { content: '‚ú¶'; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); background: #171717; padding: 0 8px; font-size: 10px; color: #F25623; }
  .pc-name { font-family: 'Playfair Display', serif; font-size: 20px; font-weight: 700; text-align: center; color: #DEDEDE; margin-bottom: 4px; }
  .pc-arch { text-align: center; font-size: 12px; font-style: italic; color: #888; margin-bottom: 18px; }
  .pc-section-title { font-size: 9px; letter-spacing: 0.25em; text-transform: uppercase; color: #F25623; margin-bottom: 10px; }
  .pc-sin-badge {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 14px; background: #1f1f1f;
    border-left: 3px solid #F25623; margin-bottom: 14px;
  }
  .pc-sin-badge-emoji { font-size: 26px; }
  .pc-sin-badge-name { font-family: 'Playfair Display', serif; font-size: 17px; font-weight: 700; color: #F25623; }
  .pc-confess-box {
    border: 1px solid #4D4D4D; padding: 14px 14px;
    font-size: 14px; font-style: italic; color: #DEDEDE; line-height: 1.7;
    margin-bottom: 14px; white-space: pre-wrap;
  }
  .pc-task-box {
    background: rgba(242,86,35,0.08); border: 1px solid rgba(242,86,35,0.3);
    padding: 12px 14px; margin-bottom: 18px;
  }
  .pc-task-label { font-size: 9px; letter-spacing: 0.2em; text-transform: uppercase; color: #F25623; margin-bottom: 4px; }
  .pc-task-text { font-size: 13px; font-style: italic; color: #DEDEDE; line-height: 1.5; }
  .pc-footer { text-align: center; font-size: 9px; letter-spacing: 0.18em; color: #4D4D4D; text-transform: uppercase; }

  .penance-overlay-close {
    margin-top: 16px; background: none; border: 1px solid #4D4D4D; color: #888;
    font-family: 'Cormorant Garamond', serif; font-size: 13px; letter-spacing: 0.1em;
    padding: 10px 28px; cursor: pointer; border-radius: 2px; transition: all 0.2s;
  }
  .penance-overlay-close:hover { border-color: #888; color: #DEDEDE; }

  /* Save penance btn inside overlay */
  .btn-save-penance {
    margin-top: 14px; width: min(320px, 90vw); padding: 14px;
    background: var(--accent); color: #fff;
    font-family: 'Playfair Display', serif; font-size: 12px; letter-spacing: 0.18em;
    text-transform: uppercase; border: none; border-radius: 2px; cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }
  .btn-save-penance:hover { background: #c04018; }
  .btn-save-penance:active { transform: scale(0.98); }

  @media (max-width: 360px) {
    .logo { font-size: 48px; }
    .sin-name { font-size: 15px; }
  }
</style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="logo">SINS</div>
    <div class="tagline">–ì—Ä–µ—à–∏—Ç—å –≤–µ—Å–µ–ª–µ–µ –≤–º–µ—Å—Ç–µ</div>
  </header>

  <div class="section">
    <div class="section-label">‚ú¶ –ò—Å–ø–æ–≤–µ–¥—å –≥—Ä–µ—à–Ω–∏–∫–∞</div>
    <div class="input-row">
      <div class="field">
        <label>–ò–º—è</label>
        <input type="text" id="inp-name" placeholder="–¢–≤–æ—ë –∏–º—è" maxlength="20">
      </div>
      <div class="field">
        <label>–í–æ–∑—Ä–∞—Å—Ç</label>
        <input type="number" id="inp-age" placeholder="21" min="18" max="99">
      </div>
    </div>
    <div class="input-row single">
      <div class="field">
        <label>–ì–æ—Ä–æ–¥</label>
        <input type="text" id="inp-city" placeholder="–ì–¥–µ –æ–±–∏—Ç–∞–µ—à—å..." maxlength="30">
      </div>
    </div>
    <div class="input-row single">
      <div class="field">
        <label>–ò—â—É</label>
        <select id="inp-seek">
          <option value="">‚Äî –≤—ã–±–µ—Ä–∏ ‚Äî</option>
          <option>–°–æ–æ–±—â–Ω–∏–∫–∞</option>
          <option>–ò—Å–∫—É–ø–ª–µ–Ω–∏–µ</option>
          <option>–°–æ—É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤ –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–∏</option>
          <option>–ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ—Å—Ç—å —Å–µ–±–µ</option>
          <option>–¢–∞–∫–æ–≥–æ –∂–µ –≥—Ä–µ—à–Ω–∏–∫–∞</option>
        </select>
      </div>
    </div>
  </div>

  <div class="ranking-section">
    <div class="ranking-title">‚ú¶ –¢–≤–æ–π —Å–º–µ—Ä—Ç–Ω—ã–π —Ç–æ–ø</div>
    <div class="ranking-hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –≥—Ä–µ—Ö–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –æ—Ç —Å–∞–º–æ–≥–æ —Ç–≤–æ–µ–≥–æ ‚Äî –¥–æ –Ω–∞–∏–º–µ–Ω–µ–µ —Ç–≤–æ–µ–≥–æ</div>
    <ul class="sin-list" id="sin-list">
      <li class="sin-item" data-id="pride" draggable="true">
        <span class="sin-rank">1</span><span class="sin-emoji">üëë</span>
        <div class="sin-info"><div class="sin-name">–ì–æ—Ä–¥—ã–Ω—è</div><div class="sin-desc">Superbia ¬∑ –Ø –ª—É—á—à–∏–π</div></div>
        <span class="drag-handle">‚†ø</span>
      </li>
      <li class="sin-item" data-id="greed" draggable="true">
        <span class="sin-rank">2</span><span class="sin-emoji">üí∞</span>
        <div class="sin-info"><div class="sin-name">–ñ–∞–¥–Ω–æ—Å—Ç—å</div><div class="sin-desc">Avaritia ¬∑ –í—Å—ë ‚Äî –º–æ—ë</div></div>
        <span class="drag-handle">‚†ø</span>
      </li>
      <li class="sin-item" data-id="lust" draggable="true">
        <span class="sin-rank">3</span><span class="sin-emoji">üåπ</span>
        <div class="sin-info"><div class="sin-name">–ü–æ—Ö–æ—Ç—å</div><div class="sin-desc">Luxuria ¬∑ –ñ–µ–ª–∞–Ω–∏–µ –±–µ–∑ –≥—Ä–∞–Ω–∏—Ü</div></div>
        <span class="drag-handle">‚†ø</span>
      </li>
      <li class="sin-item" data-id="envy" draggable="true">
        <span class="sin-rank">4</span><span class="sin-emoji">üêç</span>
        <div class="sin-info"><div class="sin-name">–ó–∞–≤–∏—Å—Ç—å</div><div class="sin-desc">Invidia ¬∑ –£ —Å–æ—Å–µ–¥–∞ –ª—É—á—à–µ</div></div>
        <span class="drag-handle">‚†ø</span>
      </li>
      <li class="sin-item" data-id="gluttony" draggable="true">
        <span class="sin-rank">5</span><span class="sin-emoji">üç∑</span>
        <div class="sin-info"><div class="sin-name">–ß—Ä–µ–≤–æ—É–≥–æ–¥–∏–µ</div><div class="sin-desc">Gula ¬∑ –ñ–∏–∑–Ω—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞</div></div>
        <span class="drag-handle">‚†ø</span>
      </li>
      <li class="sin-item" data-id="wrath" draggable="true">
        <span class="sin-rank">6</span><span class="sin-emoji">üî•</span>
        <div class="sin-info"><div class="sin-name">–ì–Ω–µ–≤</div><div class="sin-desc">Ira ¬∑ –Ø—Ä–æ—Å—Ç—å –ø—Ä–∞–≤–µ–¥–Ω–æ–≥–æ</div></div>
        <span class="drag-handle">‚†ø</span>
      </li>
      <li class="sin-item" data-id="sloth" draggable="true">
        <span class="sin-rank">7</span><span class="sin-emoji">üåô</span>
        <div class="sin-info"><div class="sin-name">–£–Ω—ã–Ω–∏–µ</div><div class="sin-desc">Acedia ¬∑ –õ–µ–Ω—å –∫–∞–∫ –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏</div></div>
        <span class="drag-handle">‚†ø</span>
      </li>
    </ul>
  </div>

  <div class="intensity-section">
    <div class="intensity-label">‚ú¶ –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –≥—Ä–µ—Ö–æ–≤</div>
    <div class="intensity-sub">–ù–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –≤—ã—Ä–∞–∂–µ–Ω –∫–∞–∂–¥—ã–π –≥—Ä–µ—Ö (1‚Äì10)</div>
    <div id="sliders"></div>
  </div>

  <div class="motto-section">
    <div class="motto-label">‚ú¶ –î–µ–≤–∏–∑ –≥—Ä–µ—à–Ω–∏–∫–∞</div>
    <div class="motto-sub">–û–¥–Ω–∞ —Ñ—Ä–∞–∑–∞, –∫–æ—Ç–æ—Ä–∞—è —Ç–µ–±—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç</div>
    <textarea id="inp-motto" rows="3" maxlength="120" placeholder="–ù–∞–ø—Ä. ¬´–ï—Å–ª–∏ –∏ –≥–æ—Ä–µ—Ç—å ‚Äî —Ç–æ —è—Ä–∫–æ¬ª"></textarea>
  </div>

  <!-- FEATURE 4: –ü–û–ö–ê–Ø–ù–ò–ï -->
  <div class="penance-section">
    <div class="penance-label">‚ú¶ –ü–æ–∫–∞—è–Ω–∏–µ</div>
    <div class="penance-sub">–í—ã–±–µ—Ä–∏ –≥—Ä–µ—Ö ‚Äî –∏ –ø—Ä–∏–∑–Ω–∞–π—Å—è –≤ –Ω—ë–º</div>
    <div class="penance-card">

      <div class="penance-sin-grid" id="penance-sins"></div>

      <div class="penance-confess" id="penance-confess">
        <span class="penance-confess-label">‚ú¶ –ò—Å–ø–æ–≤–µ–¥—å</span>
        <div class="penance-confess-sin-name" id="penance-confess-sinname"></div>
        <div class="penance-confess-prompt" id="penance-confess-prompt"></div>
        <textarea class="penance-textarea" id="penance-text" rows="4"
          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å —Å–≤–æ—ë –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ..."></textarea>
        <button class="btn-penance" id="btn-penance" onclick="showPenanceCard()">
          üïØÔ∏è &nbsp; –ü–æ–∫–∞—è—Ç—å—Å—è
        </button>
      </div>

    </div>
  </div>

  <!-- ARCHETYPE RESULT -->
  <div class="archetype-section" id="archetype-section" style="display:none">
    <div class="arch-label">‚ú¶ –¢–≤–æ–π –∞—Ä—Ö–µ—Ç–∏–ø</div>
    <div class="arch-card" id="arch-card">
      <div class="arch-symbol" id="arch-symbol"></div>
      <div class="arch-name" id="arch-name"></div>
      <div class="arch-desc" id="arch-desc"></div>
      <div class="arch-attracts" id="arch-attracts"></div>
    </div>
  </div>

  <div class="save-section">
    <button class="btn-reveal" id="btn-reveal" onclick="revealArchetype()">
      ‚ú¶ &nbsp; –£–∑–Ω–∞—Ç—å —Å–≤–æ–π –∞—Ä—Ö–µ—Ç–∏–ø
    </button>
    <div id="save-buttons" style="display:none">
      <button class="btn-save" id="btn-save" onclick="saveCard()">
        ‚Üì &nbsp; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      </button>
    </div>
    <p class="screenshot-hint">
      –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–æ—Å—å ‚Äî <a onclick="prepareScreenshot()">–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∞–Ω–∫–µ—Ç—É –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–∞</a>
    </p>
  </div>
</div>

<!-- PENANCE OVERLAY -->
<div id="penance-overlay">
  <div class="penance-overlay-hint">üïØÔ∏è –¢–≤–æ—ë –ø–æ–∫–∞—è–Ω–∏–µ</div>
  <div id="penance-card"></div>
  <button class="btn-save-penance" onclick="savePenanceCard()">‚Üì &nbsp; –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
  <button class="penance-overlay-close" onclick="closePenanceOverlay()">‚úï &nbsp; –ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<!-- SCREENSHOT OVERLAY -->
<div id="screenshot-overlay">
  <div class="overlay-hint">üì± –°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç —ç–∫—Ä–∞–Ω–∞<br><span style="font-size:11px;color:#4a3040">–∫–∞—Ä—Ç–æ—á–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ 2/3 —ç–∫—Ä–∞–Ω–∞ iPhone 17</span></div>
  <div id="screenshot-card"></div>
  <button class="overlay-close" onclick="closeScreenshot()">‚úï &nbsp; –ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const sinData = {
  pride:    { name: '–ì–æ—Ä–¥—ã–Ω—è',     emoji: 'üëë', lat: 'Superbia' },
  greed:    { name: '–ñ–∞–¥–Ω–æ—Å—Ç—å',    emoji: 'üí∞', lat: 'Avaritia' },
  lust:     { name: '–ü–æ—Ö–æ—Ç—å',      emoji: 'üåπ', lat: 'Luxuria' },
  envy:     { name: '–ó–∞–≤–∏—Å—Ç—å',     emoji: 'üêç', lat: 'Invidia' },
  gluttony: { name: '–ß—Ä–µ–≤–æ—É–≥–æ–¥–∏–µ', emoji: 'üç∑', lat: 'Gula' },
  wrath:    { name: '–ì–Ω–µ–≤',        emoji: 'üî•', lat: 'Ira' },
  sloth:    { name: '–£–Ω—ã–Ω–∏–µ',      emoji: 'üåô', lat: 'Acedia' },
};
const sliderVals = {};
Object.keys(sinData).forEach(k => sliderVals[k] = 5);

// ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const list = document.getElementById('sin-list');
let dragSrc = null;
let touchItem = null, touchClone = null, touchStartY = 0, touchItemInitialTop = 0;

function updateRanks() {
  list.querySelectorAll('.sin-item').forEach((el, i) => {
    el.querySelector('.sin-rank').textContent = i + 1;
  });
  rebuildSliders();
}

// Mouse drag
list.addEventListener('dragstart', e => {
  dragSrc = e.target.closest('.sin-item');
  if (dragSrc) dragSrc.classList.add('dragging');
});
list.addEventListener('dragend', () => {
  if (dragSrc) dragSrc.classList.remove('dragging');
  list.querySelectorAll('.sin-item').forEach(el => el.classList.remove('drag-over'));
  updateRanks();
});
list.addEventListener('dragover', e => {
  e.preventDefault();
  const target = e.target.closest('.sin-item');
  if (!target || target === dragSrc) return;
  list.querySelectorAll('.sin-item').forEach(el => el.classList.remove('drag-over'));
  target.classList.add('drag-over');
  const r = target.getBoundingClientRect();
  list.insertBefore(dragSrc, e.clientY < r.top + r.height / 2 ? target : target.nextSibling);
});

// Touch drag
list.addEventListener('touchstart', e => {
  touchItem = e.target.closest('.sin-item');
  if (!touchItem) return;
  touchStartY = e.touches[0].clientY;
  touchItemInitialTop = touchItem.getBoundingClientRect().top;
  touchClone = touchItem.cloneNode(true);
  Object.assign(touchClone.style, {
    position: 'fixed', left: '20px', right: '20px', zIndex: '999',
    opacity: '0.9', pointerEvents: 'none', background: '#2a2a2a',
    border: '1px solid #F25623', borderRadius: '2px', margin: '0',
    top: touchItemInitialTop + 'px', transition: 'none',
  });
  document.body.appendChild(touchClone);
  touchItem.classList.add('dragging');
}, { passive: true });

document.addEventListener('touchmove', e => {
  if (!touchItem || !touchClone) return;
  e.preventDefault();
  const y = e.touches[0].clientY;
  touchClone.style.top = (touchItemInitialTop + (y - touchStartY)) + 'px';
  const el = document.elementFromPoint(e.touches[0].clientX, y);
  const target = el && el.closest('.sin-item');
  if (target && target !== touchItem) {
    list.querySelectorAll('.sin-item').forEach(el => el.classList.remove('drag-over'));
    target.classList.add('drag-over');
    const r = target.getBoundingClientRect();
    list.insertBefore(touchItem, y < r.top + r.height / 2 ? target : target.nextSibling);
  }
}, { passive: false });

document.addEventListener('touchend', () => {
  if (!touchItem) return;
  touchItem.classList.remove('dragging');
  list.querySelectorAll('.sin-item').forEach(el => el.classList.remove('drag-over'));
  if (touchClone) { touchClone.remove(); touchClone = null; }
  touchItem = null;
  updateRanks();
});

// ‚îÄ‚îÄ SLIDERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getOrder() {
  return [...list.querySelectorAll('.sin-item')].map(el => el.dataset.id);
}

function rebuildSliders() {
  const cont = document.getElementById('sliders');
  const order = getOrder();
  cont.innerHTML = '';
  order.forEach(id => {
    const row = document.createElement('div');
    row.className = 'slider-row';
    row.innerHTML = `
      <span class="slider-sin-name">${sinData[id].emoji} ${sinData[id].name}</span>
      <input type="range" min="1" max="10" value="${sliderVals[id]}" data-sid="${id}">
      <span class="slider-val" id="sv-${id}">${sliderVals[id]}</span>
    `;
    row.querySelector('input').addEventListener('input', function() {
      sliderVals[this.dataset.sid] = +this.value;
      document.getElementById('sv-' + this.dataset.sid).textContent = this.value;
    });
    cont.appendChild(row);
  });
}
rebuildSliders();
// Build penance sins list on load
setTimeout(buildPenanceSins, 0);

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getFormData() {
  return {
    name:  document.getElementById('inp-name').value.trim() || '–ê–Ω–æ–Ω–∏–º',
    age:   document.getElementById('inp-age').value || '?',
    city:  document.getElementById('inp-city').value.trim() || '‚Äî',
    seek:  document.getElementById('inp-seek').value || '‚Äî',
    motto: document.getElementById('inp-motto').value.trim(),
    order: getOrder(),
    archetype: currentArchetype || calcArchetype(),
  };
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 4000);
}

// ‚îÄ‚îÄ FEATURE 4: –ü–û–ö–ê–Ø–ù–ò–ï ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const penanceData = {
  pride:    { prompt: '–í —á—ë–º —Ç–≤–æ—è –≥–æ—Ä–¥—ã–Ω—è –ø—Ä–∏—á–∏–Ω–∏–ª–∞ –≤—Ä–µ–¥ —Ç–µ–±–µ –∏–ª–∏ –¥—Ä—É–≥–∏–º?',    task: '–ü–æ–∑–≤–æ–ª—å –¥—Ä—É–≥–æ–º—É –±—ã—Ç—å –ø—Ä–∞–≤—ã–º ‚Äî –±–µ–∑ —Å–ø–æ—Ä–∞' },
  greed:    { prompt: '–ß—Ç–æ —Ç—ã —É–¥–µ—Ä–∂–∏–≤–∞–ª, —Ö–æ—Ç—è –º–æ–≥ –±—ã –æ—Ç–¥–∞—Ç—å?',                task: '–û—Ç–¥–∞–π —á—Ç–æ-—Ç–æ —Ü–µ–Ω–Ω–æ–µ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞' },
  lust:     { prompt: '–ö–æ–≥–¥–∞ –∂–µ–ª–∞–Ω–∏–µ –∑–∞–≤–µ–ª–æ —Ç–µ–±—è –Ω–µ —Ç—É–¥–∞?',                   task: '–û–¥–∏–Ω –¥–µ–Ω—å ‚Äî —Ü–µ–Ω–∏ —á–µ–ª–æ–≤–µ–∫–∞ –∑–∞ —Å–ª–æ–≤–∞, –Ω–µ –∑–∞ –≤–Ω–µ—à–Ω–æ—Å—Ç—å' },
  envy:     { prompt: '–ß–µ–π —É—Å–ø–µ—Ö –ø—Ä–∏—á–∏–Ω—è–ª —Ç–µ–±–µ –±–æ–ª—å ‚Äî –∏ –ø–æ—á–µ–º—É?',             task: '–ò—Å–∫—Ä–µ–Ω–Ω–µ –ø–æ—Ä–∞–¥—É–π—Å—è –∑–∞ —Ç–æ–≥–æ –∫–æ–º—É –∑–∞–≤–∏–¥—É–µ—à—å' },
  gluttony: { prompt: '–ß—Ç–æ —Ç—ã –ø–æ—Ç—Ä–µ–±–ª—è–ª —Å–≤–µ—Ä—Ö –º–µ—Ä—ã ‚Äî –∏ —á—Ç–æ —ç—Ç–æ —Å–∫—Ä—ã–≤–∞–ª–æ?',    task: '–û–¥–∏–Ω –ø—Ä–æ—Å—Ç–æ–π —É–∂–∏–Ω. –ë–µ–∑ –∏–∑–ª–∏—à–µ—Å—Ç–≤' },
  wrath:    { prompt: '–ö–æ–º—É —Ç—ã –ø—Ä–∏—á–∏–Ω–∏–ª –±–æ–ª—å —Å–≤–æ–∏–º –≥–Ω–µ–≤–æ–º?',                  task: '–î–æ—Å—á–∏—Ç–∞–π –¥–æ –¥–µ—Å—è—Ç–∏. –ü–æ—Ç–æ–º –æ—Ç–≤–µ—Ç—å' },
  sloth:    { prompt: '–ß—Ç–æ –≤–∞–∂–Ω–æ–µ —Ç—ã –æ—Ç–∫–ª–∞–¥—ã–≤–∞–ª ‚Äî –∏ —á–µ–≥–æ —ç—Ç–æ —Å—Ç–æ–∏–ª–æ?',        task: '–°–¥–µ–ª–∞–π –æ–¥–Ω–æ –≤–∞–∂–Ω–æ–µ –¥–µ–ª–æ ‚Äî –ø—Ä—è–º–æ —Å–µ–≥–æ–¥–Ω—è' },
};

let penanceSin = null;

function buildPenanceSins() {
  const cont = document.getElementById('penance-sins');
  cont.innerHTML = '';
  getOrder().forEach(id => {
    const s = sinData[id];
    const opt = document.createElement('div');
    opt.className = 'penance-sin-opt';
    opt.dataset.id = id;
    opt.innerHTML = `
      <span class="p-emoji">${s.emoji}</span>
      <span class="p-name">${s.name}</span>
      <span class="p-hint">${s.lat}</span>
      <span class="p-dot"></span>`;
    opt.onclick = () => selectPenanceSin(id);
    cont.appendChild(opt);
  });
}

function selectPenanceSin(id) {
  document.querySelectorAll('.penance-sin-opt').forEach(o =>
    o.classList.toggle('selected', o.dataset.id === id));
  penanceSin = id;

  const s = sinData[id];
  const d = penanceData[id];
  document.getElementById('penance-confess-sinname').textContent = s.emoji + '  ' + s.name;
  document.getElementById('penance-confess-prompt').textContent = d.prompt;
  document.getElementById('penance-text').value = '';

  const confess = document.getElementById('penance-confess');
  confess.classList.add('visible');
  confess.style.animation = 'none';
  confess.offsetHeight;
  confess.style.animation = '';
  confess.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showPenanceCard() {
  if (!penanceSin) return;
  const name = document.getElementById('inp-name').value.trim() || '–ê–Ω–æ–Ω–∏–º';
  const archetype = currentArchetype || calcArchetype();
  const s = sinData[penanceSin];
  const d = penanceData[penanceSin];
  const text = document.getElementById('penance-text').value.trim() || '‚Ä¶';

  const card = document.getElementById('penance-card');
  card.innerHTML = `
    <div class="pc-logo">SINS</div>
    <div class="pc-rule"></div>
    <div class="pc-name">${name}</div>
    <div class="pc-arch">${archetype.symbol} ${archetype.name}</div>
    <div class="pc-section-title">‚ú¶ –ø–æ–∫–∞—è–Ω–∏–µ</div>
    <div class="pc-sin-badge">
      <span class="pc-sin-badge-emoji">${s.emoji}</span>
      <span class="pc-sin-badge-name">${s.name}</span>
    </div>
    <div class="pc-confess-box">${text}</div>
    <div class="pc-task-box">
      <div class="pc-task-label">–æ–±–µ—Ç</div>
      <div class="pc-task-text">${d.task}</div>
    </div>
    <div class="pc-footer">sins.app ¬∑ ${new Date().getFullYear()}</div>
  `;

  document.getElementById('penance-overlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closePenanceOverlay() {
  document.getElementById('penance-overlay').classList.remove('active');
  document.body.style.overflow = '';
}

document.getElementById('penance-overlay').addEventListener('click', function(e) {
  if (e.target === this) closePenanceOverlay();
});

async function savePenanceCard() {
  if (!penanceSin) return;
  await document.fonts.ready;

  const name = document.getElementById('inp-name').value.trim() || '–ê–Ω–æ–Ω–∏–º';
  const archetype = currentArchetype || calcArchetype();
  const s = sinData[penanceSin];
  const d = penanceData[penanceSin];
  const text = document.getElementById('penance-text').value.trim() || '‚Ä¶';

  const W = 800, H = 1000;
  const canvas = document.createElement('canvas');
  canvas.width = W; canvas.height = H;
  const ctx = canvas.getContext('2d');

  // BG
  ctx.fillStyle = '#171717';
  ctx.fillRect(0, 0, W, H);

  // Glow
  const g = ctx.createRadialGradient(W/2, H*0.1, 0, W/2, H*0.1, W*0.7);
  g.addColorStop(0, 'rgba(242,86,35,0.13)');
  g.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g; ctx.fillRect(0, 0, W, H);

  const g2 = ctx.createRadialGradient(W/2, H, 0, W/2, H, W*0.5);
  g2.addColorStop(0, 'rgba(242,86,35,0.06)');
  g2.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g2; ctx.fillRect(0, 0, W, H);

  // Border
  ctx.strokeStyle = '#4D4D4D'; ctx.lineWidth = 1.5;
  ctx.strokeRect(18, 18, W-36, H-36);

  // Corner marks
  const corner = (x, y, sx, sy) => {
    ctx.strokeStyle = '#F25623'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x, y+sy*18); ctx.lineTo(x, y); ctx.lineTo(x+sx*18, y); ctx.stroke();
  };
  corner(24,24,1,1); corner(W-24,24,-1,1); corner(24,H-24,1,-1); corner(W-24,H-24,-1,-1);

  let y = 72;

  // Logo
  ctx.textAlign = 'center'; ctx.letterSpacing = '12px';
  ctx.font = 'bold 72px "Playfair Display", serif';
  ctx.fillStyle = '#F25623';
  ctx.fillText('SINS', W/2, y + 52);
  y += 80;

  // Divider
  ctx.strokeStyle = '#4D4D4D'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(70, y); ctx.lineTo(W-70, y); ctx.stroke();
  ctx.font = '16px serif'; ctx.fillStyle = '#F25623'; ctx.letterSpacing = '0px';
  ctx.fillText('‚ú¶', W/2, y + 9);
  y += 32;

  // Name
  ctx.font = 'bold 42px "Playfair Display", serif';
  ctx.fillStyle = '#DEDEDE'; ctx.letterSpacing = '1px';
  ctx.fillText(name, W/2, y);
  y += 30;

  // Archetype
  ctx.font = 'italic 20px "Cormorant Garamond", serif';
  ctx.fillStyle = '#888'; ctx.letterSpacing = '1px';
  ctx.fillText(`${archetype.symbol}  ${archetype.name}`, W/2, y);
  y += 44;

  // Section: –ø–æ–∫–∞—è–Ω–∏–µ
  ctx.textAlign = 'left'; ctx.letterSpacing = '4px';
  ctx.font = '600 12px "Cormorant Garamond", serif';
  ctx.fillStyle = '#F25623';
  ctx.fillText('‚ú¶  –ü–û–ö–ê–Ø–ù–ò–ï', 64, y);
  y += 22;

  // Sin badge
  const bh = 70;
  ctx.fillStyle = '#1f1f1f'; ctx.fillRect(64, y, W-128, bh);
  ctx.fillStyle = '#F25623'; ctx.fillRect(64, y, 4, bh);
  ctx.font = '34px serif'; ctx.letterSpacing = '0px'; ctx.textAlign = 'left';
  ctx.fillText(s.emoji, 88, y + 42);
  ctx.font = 'bold 26px "Playfair Display", serif';
  ctx.fillStyle = '#F25623';
  ctx.fillText(s.name, 134, y + 30);
  ctx.font = 'italic 16px "Cormorant Garamond", serif';
  ctx.fillStyle = '#888';
  ctx.fillText(s.lat, 134, y + 52);
  y += bh + 20;

  // Confession text box
  ctx.strokeStyle = '#4D4D4D'; ctx.lineWidth = 1;
  const confLines = wrapText(ctx, text, W-168, 'italic 19px "Cormorant Garamond", serif');
  const confH = Math.max(80, confLines.length * 30 + 40);
  ctx.strokeRect(64, y, W-128, confH);
  ctx.font = 'italic 19px "Cormorant Garamond", serif';
  ctx.fillStyle = '#DEDEDE'; ctx.letterSpacing = '0.3px';
  confLines.forEach((l, i) => ctx.fillText(l, 84, y + 32 + i * 30));
  y += confH + 22;

  // Oath box
  const oathH = 80;
  ctx.fillStyle = 'rgba(242,86,35,0.07)'; ctx.fillRect(64, y, W-128, oathH);
  ctx.strokeStyle = 'rgba(242,86,35,0.35)'; ctx.lineWidth = 1;
  ctx.strokeRect(64, y, W-128, oathH);
  ctx.font = '600 11px "Cormorant Garamond", serif';
  ctx.fillStyle = '#F25623'; ctx.letterSpacing = '3px';
  ctx.fillText('–û–ë–ï–¢', 84, y + 22);
  ctx.font = 'italic 17px "Cormorant Garamond", serif';
  ctx.fillStyle = '#DEDEDE'; ctx.letterSpacing = '0.3px';
  const oathLines = wrapText(ctx, d.task, W-188, 'italic 17px "Cormorant Garamond", serif');
  oathLines.forEach((l, i) => ctx.fillText(l, 84, y + 44 + i * 24));
  y += oathH + 30;

  // Footer
  ctx.textAlign = 'center'; ctx.font = '13px "Cormorant Garamond", serif';
  ctx.fillStyle = '#4D4D4D'; ctx.letterSpacing = '3px';
  ctx.fillText('SINS.APP ¬∑ ' + new Date().getFullYear(), W/2, H - 32);

  // Download
  try {
    canvas.toBlob(blob => {
      if (!blob) { fallbackSave(canvas, name); return; }
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.download = `sins-pokayanie-${name.toLowerCase().replace(/\s+/g,'-')}.png`;
      a.href = url;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 5000);
      showToast('üïØÔ∏è –ü–æ–∫–∞—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }, 'image/png');
  } catch(e) { fallbackSave(canvas, name); }
}

function fallbackSave(canvas, name) {
  try {
    const a = document.createElement('a');
    a.download = `sins-pokayanie-${(name||'').toLowerCase().replace(/\s+/g,'-')}.png`;
    a.href = canvas.toDataURL('image/png');
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    showToast('üïØÔ∏è –ü–æ–∫–∞—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
  } catch(e) { showToast('‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å ‚Äî —Å–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç'); }
}

function wrapText(ctx, text, maxW, font) {
  ctx.font = font;
  const words = text.split(' ');
  let line = '', lines = [];
  words.forEach(w => {
    const test = line ? line + ' ' + w : w;
    if (ctx.measureText(test).width > maxW && line) { lines.push(line); line = w; }
    else line = test;
  });
  if (line) lines.push(line);
  return lines;
}

// ‚îÄ‚îÄ ARCHETYPE ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ARCHETYPES = [
  {
    id: 'demon',
    name: '–î–µ–º–æ–Ω',
    symbol: 'üåë',
    desc: '–ù–µ —Å–∫—Ä—ã–≤–∞–µ—Ç –Ω–∏—á–µ–≥–æ. –¢—ë–º–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞. –ü—É–≥–∞–µ—Ç ‚Äî –Ω–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ —á–µ—Å—Ç–µ–Ω. –°–∞–º—ã–π —Ä–µ–¥–∫–∏–π –∞—Ä—Ö–µ—Ç–∏–ø.',
    attracts: ['–ê–Ω–≥–µ–ª –≤ –ø–∞–¥–µ–Ω–∏–∏', '–ê—Å–∫–µ—Ç'],
    match: (top, vals, total) => total >= 60 && Object.values(vals).every(v => v >= 7),
  },
  {
    id: 'trickster',
    name: '–¢—Ä–∏–∫—Å—Ç–µ—Ä',
    symbol: 'üÉè',
    desc: '–ñ–∏–≤—ë—Ç –Ω–∞ –≥—Ä–∞–Ω–∏, –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞–¥–∏ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏—è. –û–±–∞—è—Ç–µ–ª–µ–Ω –∏ –æ–ø–∞—Å–µ–Ω –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. –ó–Ω–∞–µ—Ç —Ç–≤–æ–∏ —Å–ª–∞–±–æ—Å—Ç–∏ —Ä–∞–Ω—å—à–µ —Ç–µ–±—è.',
    attracts: ['–ü—Ä–∞–≤–µ–¥–Ω–∏–∫', '–ê–Ω–≥–µ–ª –≤ –ø–∞–¥–µ–Ω–∏–∏'],
    match: (top, vals, total) => top[0] === 'pride' && top.slice(0,3).includes('lust') && total >= 38,
  },
  {
    id: 'heretic',
    name: '–ï—Ä–µ—Ç–∏–∫',
    symbol: 'üíÄ',
    desc: '–û—Ç—Ä–∏—Ü–∞–µ—Ç –≤—Å—ë ‚Äî —Å–∏—Å—Ç–µ–º—É, –º–æ—Ä–∞–ª—å, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç—ã. –ì—Ä–µ—Ö–∏ –Ω–æ—Å–∏—Ç –∫–∞–∫ –º–∞–Ω–∏—Ñ–µ—Å—Ç. –†–∞–∑—Ä—É—à–µ–Ω–∏–µ –∫–∞–∫ —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –∞–∫—Ç.',
    attracts: ['–ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫', '–ú—É—á–µ–Ω–∏–∫'],
    match: (top, vals, total) => top[0] === 'pride' && top[1] === 'wrath' && total >= 45,
  },
  {
    id: 'righteous',
    name: '–ü—Ä–∞–≤–µ–¥–Ω–∏–∫',
    symbol: '‚öîÔ∏è',
    desc: '–ì–æ—Ä–∏—Ç –æ—Ç –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç–∏. –ê–≥—Ä–µ—Å—Å–∏—è ‚Äî —ç—Ç–æ –ª—é–±–æ–≤—å, –≤—ã–≤–µ—Ä–Ω—É—Ç–∞—è –Ω–∞–∏–∑–Ω–∞–Ω–∫—É. –í–æ—é–µ—Ç –∑–∞ –ø—Ä–∞–≤–¥—É, –Ω–æ –ª–∏–Ω–∏—é –¥–∞–≤–Ω–æ –ø–æ—Ç–µ—Ä—è–ª.',
    attracts: ['–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü', '–ì—Ä–µ—à–Ω–∏–∫'],
    match: (top, vals, total) => top[0] === 'wrath' && total >= 38,
  },
  {
    id: 'tempter',
    name: '–ò—Å–∫—É—Å–∏—Ç–µ–ª—å',
    symbol: 'üêç',
    desc: '–í–∏–¥–∏—Ç —Ü–µ–Ω—É –≤—Å–µ–≥–æ –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å –Ω–∏—á–µ–≥–æ. –£–º–µ–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–æ, —á—Ç–æ —Ç—ã —Ö–æ—Ç–µ–ª, –Ω–æ –±–æ—è–ª—Å—è –ø–æ–ø—Ä–æ—Å–∏—Ç—å. –°–¥–µ–ª–∫–∞ –≤—Å–µ–≥–¥–∞ –≤ –µ–≥–æ –ø–æ–ª—å–∑—É.',
    attracts: ['–ê–Ω–≥–µ–ª –≤ –ø–∞–¥–µ–Ω–∏–∏', '–ú—É—á–µ–Ω–∏–∫'],
    match: (top, vals, total) => top[0] === 'greed' && top[1] === 'envy',
  },
  {
    id: 'preacher',
    name: '–ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫',
    symbol: 'üìñ',
    desc: '–ó–Ω–∞–µ—Ç –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî –∏ –Ω–µ —Å—Ç–µ—Å–Ω—è–µ—Ç—Å—è –æ–± —ç—Ç–æ–º –≥–æ–≤–æ—Ä–∏—Ç—å. –ì—Ä–µ—à–∏—Ç —Å–∞–º, –Ω–æ —Å—É–¥–∏—Ç –¥—Ä—É–≥–∏—Ö. –õ–∏—Ü–µ–º–µ—Ä–∏–µ –∫–∞–∫ –≤—ã—Å–æ–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ.',
    attracts: ['–ì—Ä–µ—à–Ω–∏–∫', '–ï—Ä–µ—Ç–∏–∫'],
    match: (top, vals, total) => top[0] === 'pride' && top.slice(0,3).includes('envy') && total >= 26 && total <= 45,
  },
  {
    id: 'sinner',
    name: '–ì—Ä–µ—à–Ω–∏–∫',
    symbol: 'üî•',
    desc: '–ñ–∏–≤—ë—Ç –∑–¥–µ—Å—å –∏ —Å–µ–π—á–∞—Å. –¢–µ–ª–æ –≤–∞–∂–Ω–µ–µ –¥—É—Ö–∞, –º–æ–º–µ–Ω—Ç –≤–∞–∂–Ω–µ–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π. –ù–µ —Ä–∞—Å–∫–∞–∏–≤–∞–µ—Ç—Å—è ‚Äî –Ω–∞—Å–ª–∞–∂–¥–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–º –º–≥–Ω–æ–≤–µ–Ω–∏–µ–º.',
    attracts: ['–ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫', '–ê—Å–∫–µ—Ç'],
    match: (top, vals, total) => (top[0] === 'lust' || top[1] === 'lust') && top.slice(0,3).includes('gluttony') && total >= 40,
  },
  {
    id: 'martyr',
    name: '–ú—É—á–µ–Ω–∏–∫',
    symbol: 'üïØÔ∏è',
    desc: '–°—Ç—Ä–∞–¥–∞–µ—Ç –∫—Ä–∞—Å–∏–≤–æ. –ß—É–∂–æ–π —É—Å–ø–µ—Ö ‚Äî –ª–∏—á–Ω–∞—è —Ç—Ä–∞–≥–µ–¥–∏—è. –ë–æ–ª—å –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å. –ò—â–µ—Ç —Ç–æ–≥–æ –∫—Ç–æ —Å–ø–∞—Å—ë—Ç ‚Äî –∏–ª–∏ —Ä–∞–∑–¥–µ–ª–∏—Ç —Å—Ç—Ä–∞–¥–∞–Ω–∏–µ.',
    attracts: ['–ò—Å–∫—É—Å–∏—Ç–µ–ª—å', '–ü—Ä–∞–≤–µ–¥–Ω–∏–∫'],
    match: (top, vals, total) => top[0] === 'envy' && top.slice(0,3).includes('sloth'),
  },
  {
    id: 'angel',
    name: '–ê–Ω–≥–µ–ª –≤ –ø–∞–¥–µ–Ω–∏–∏',
    symbol: 'üëº',
    desc: '–°–ª–∏—à–∫–æ–º —á–∏—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ –º–∏—Ä–∞ ‚Äî –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —É—Å—Ç–∞–ª –æ—Ç –Ω–µ–≥–æ. –ì—Ä–µ—Ö–∏ –µ—Å—Ç—å, –Ω–æ –æ–Ω–∏ —Ç–∏—Ö–∏–µ –∏ –∫—Ä–∞—Å–∏–≤—ã–µ. –°—Ç—Ä–∞–¥–∞–µ—Ç –º–æ–ª—á–∞ –∏ —Å –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–æ–º.',
    attracts: ['–î–µ–º–æ–Ω', '–¢—Ä–∏–∫—Å—Ç–µ—Ä'],
    match: (top, vals, total) => top[0] === 'sloth' && total <= 28,
  },
  {
    id: 'ascetic',
    name: '–ê—Å–∫–µ—Ç',
    symbol: 'üëÅÔ∏è',
    desc: '–ö–æ–Ω—Ç—Ä–æ–ª—å ‚Äî —ç—Ç–æ –µ–≥–æ –≥—Ä–µ—Ö. –û—Ç–∫–∞–∑ –æ—Ç —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–π —Å—Ç–∞–ª –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –≥–æ—Ä–¥–æ—Å—Ç–∏. –°–∞–º—ã–π –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ –≤ –∫–æ–º–Ω–∞—Ç–µ ‚Äî –∏ —Å–∞–º—ã–π –æ–¥–∏–Ω–æ–∫–∏–π.',
    attracts: ['–ì—Ä–µ—à–Ω–∏–∫', '–î–µ–º–æ–Ω'],
    match: (top, vals, total) => top.indexOf('lust') >= 4 && top.indexOf('gluttony') >= 4 && total < 25,
  },
  {
    id: 'peacemaker',
    name: '–ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü',
    symbol: 'üïäÔ∏è',
    desc: '–ò–∑–±–µ–≥–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ª—é–±–æ–π —Ü–µ–Ω–æ–π. –ì—Ä–µ—Ö–∏ –º—è–≥–∫–∏–µ ‚Äî —á–∞–π, –¥–∏–≤–∞–Ω, —Ç–∏—à–∏–Ω–∞. –¢–∏—Ö–æ–µ —Å—á–∞—Å—Ç—å–µ –∫–∞–∫ —Ñ–æ—Ä–º–∞ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –º–∏—Ä—É.',
    attracts: ['–ü—Ä–∞–≤–µ–¥–Ω–∏–∫', '–ò—Å–∫—É—Å–∏—Ç–µ–ª—å'],
    match: (top, vals, total) => top.slice(0,3).includes('sloth') && top.slice(0,3).includes('gluttony') && top.indexOf('wrath') >= 4,
  },
  {
    id: 'chaos',
    name: '–•–∞–æ—Ç',
    symbol: 'üåÄ',
    desc: '–ù–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º –¥–∞–∂–µ –¥–ª—è —Å–µ–±—è. –°–µ–≥–æ–¥–Ω—è –ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü, –∑–∞–≤—Ç—Ä–∞ –ï—Ä–µ—Ç–∏–∫. –°–∏—Å—Ç–µ–º–∞ –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤ –Ω–∞ –Ω—ë–º –ª–æ–º–∞–µ—Ç—Å—è ‚Äî –∏ –æ–Ω —ç—Ç–∏–º –¥–æ–≤–æ–ª–µ–Ω.',
    attracts: ['–≤—Å–µ—Ö –∏ –Ω–∏–∫–æ–≥–æ'],
    match: (top, vals, total) => {
      const v = Object.values(vals);
      const spread = Math.max(...v) - Math.min(...v);
      return spread <= 2;
    },
  },
];

let currentArchetype = null;

function calcArchetype() {
  const order = getOrder();
  const total = Object.values(sliderVals).reduce((a, b) => a + b, 0);
  for (const arch of ARCHETYPES) {
    if (arch.match(order, sliderVals, total)) return arch;
  }
  // Fallback ‚Äî –ø–æ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–µ–º—É –≥—Ä–µ—Ö—É
  const fallbacks = {
    pride: ARCHETYPES.find(a => a.id === 'preacher'),
    greed: ARCHETYPES.find(a => a.id === 'tempter'),
    lust:  ARCHETYPES.find(a => a.id === 'sinner'),
    envy:  ARCHETYPES.find(a => a.id === 'martyr'),
    gluttony: ARCHETYPES.find(a => a.id === 'peacemaker'),
    wrath: ARCHETYPES.find(a => a.id === 'righteous'),
    sloth: ARCHETYPES.find(a => a.id === 'angel'),
  };
  return fallbacks[order[0]] || ARCHETYPES[ARCHETYPES.length - 1];
}

function revealArchetype() {
  currentArchetype = calcArchetype();
  const sec = document.getElementById('archetype-section');
  const card = document.getElementById('arch-card');

  document.getElementById('arch-symbol').textContent = currentArchetype.symbol;
  document.getElementById('arch-name').textContent = currentArchetype.name;
  document.getElementById('arch-desc').textContent = currentArchetype.desc;
  document.getElementById('arch-attracts').innerHTML =
    `–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç: <span>${currentArchetype.attracts.join(', ')}</span>`;

  sec.style.display = 'block';
  // Re-trigger animation
  card.style.animation = 'none';
  card.offsetHeight; // reflow
  card.style.animation = '';

  // Show save button
  document.getElementById('save-buttons').style.display = 'block';
  document.getElementById('btn-reveal').textContent = '‚Ü∫  –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∞—Ä—Ö–µ—Ç–∏–ø';

  sec.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// ‚îÄ‚îÄ CANVAS DRAW & SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Draws card on Canvas directly ‚Äî no html2canvas dependency, works in all browsers
async function saveCard() {
  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.textContent = '‚è≥  –†–∏—Å—É–µ–º –∫–∞—Ä—Ç–æ—á–∫—É...';

  try {
    await document.fonts.ready;
  } catch(e) {}

  const data = getFormData();
  const W = 800, H = 1280;
  const canvas = document.createElement('canvas');
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');

  // BG
  ctx.fillStyle = '#171717';
  ctx.fillRect(0, 0, W, H);

  // Glow gradients
  const g1 = ctx.createRadialGradient(W*0.25, H*0.12, 0, W*0.25, H*0.12, W*0.65);
  g1.addColorStop(0, 'rgba(242,86,35,0.14)');
  g1.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g1; ctx.fillRect(0, 0, W, H);

  const g2 = ctx.createRadialGradient(W*0.8, H*0.9, 0, W*0.8, H*0.9, W*0.55);
  g2.addColorStop(0, 'rgba(242,86,35,0.07)');
  g2.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = g2; ctx.fillRect(0, 0, W, H);

  // Border
  ctx.strokeStyle = '#4D4D4D';
  ctx.lineWidth = 2;
  ctx.strokeRect(18, 18, W-36, H-36);

  // Corner ornaments
  const orn = (x, y, sx, sy) => {
    ctx.strokeStyle = "#F25623"; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x, y+sy*20); ctx.lineTo(x, y); ctx.lineTo(x+sx*20, y); ctx.stroke();
  };
  orn(24,24,1,1); orn(W-24,24,-1,1); orn(24,H-24,1,-1); orn(W-24,H-24,-1,-1);

  let y = 72;

  // Logo
  ctx.textAlign = 'center';
  ctx.letterSpacing = '14px';
  ctx.font = 'bold 88px "Playfair Display", serif';
  ctx.fillStyle = '#F25623';
  ctx.fillText('SINS', W/2, y + 64);
  y += 100;

  // Tagline
  ctx.font = 'italic 22px "Cormorant Garamond", serif';
  ctx.fillStyle = '#888888';
  ctx.letterSpacing = '2px';
  ctx.fillText('–ì—Ä–µ—à–∏—Ç—å –≤–µ—Å–µ–ª–µ–µ –≤–º–µ—Å—Ç–µ', W/2, y);
  y += 38;

  // Divider
  ctx.strokeStyle = '#4D4D4D'; ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(70, y); ctx.lineTo(W-70, y); ctx.stroke();
  ctx.font = '20px serif'; ctx.fillStyle = '#F25623'; ctx.letterSpacing = '0px';
  ctx.fillText('‚ú¶', W/2, y + 10);
  y += 40;

  // Name
  ctx.font = 'bold 46px "Playfair Display", serif';
  ctx.fillStyle = '#DEDEDE'; ctx.letterSpacing = '1px';
  ctx.fillText(data.name, W/2, y);
  y += 36;

  // Meta
  ctx.font = 'italic 21px "Cormorant Garamond", serif';
  ctx.fillStyle = '#888888'; ctx.letterSpacing = '0.5px';
  ctx.fillText(`${data.age} –ª–µ—Ç ¬∑ ${data.city} ¬∑ –ò—â–µ—Ç: ${data.seek}`, W/2, y);
  y += 42;

  // Section heading
  ctx.textAlign = 'left';
  ctx.font = '600 13px "Cormorant Garamond", serif';
  ctx.fillStyle = '#F25623'; ctx.letterSpacing = '4px';
  ctx.fillText('‚ú¶  –ú–û–ô –°–ú–ï–†–¢–ù–´–ô –¢–û–ü', 64, y);
  y += 22;

  // Sin rows
  const accentBar = ['#F25623', '#c04018', '#8a2e10'];
  const rowH = 74;

  data.order.forEach((id, i) => {
    const s = sinData[id];
    const val = sliderVals[id];
    const rx = 64, rw = W - 128;

    // Row bg
    ctx.fillStyle = '#1f1f1f';
    ctx.fillRect(rx, y, rw, rowH - 8);

    // Left bar
    ctx.fillStyle = i < 3 ? accentBar[i] : '#4D4D4D';
    ctx.fillRect(rx, y, 4, rowH - 8);

    // Rank
    ctx.textAlign = 'left';
    ctx.font = `bold ${i === 0 ? 36 : 30}px "Playfair Display", serif`;
    ctx.fillStyle = '#F25623'; ctx.letterSpacing = '0px';
    ctx.fillText(i + 1, rx + 18, y + (rowH - 8)/2 + 11);

    // Emoji
    ctx.font = '30px serif';
    ctx.fillText(s.emoji, rx + 62, y + (rowH - 8)/2 + 10);

    // Sin name
    ctx.font = 'bold 23px "Playfair Display", serif';
    ctx.fillStyle = '#DEDEDE';
    ctx.fillText(s.name, rx + 106, y + (rowH - 8)/2 + 3);

    // Latin
    ctx.font = 'italic 15px "Cormorant Garamond", serif';
    ctx.fillStyle = '#888888';
    ctx.fillText(s.lat, rx + 106, y + (rowH - 8)/2 + 20);

    // Intensity bar track
    const bx = rx + rw - 126, bw = 84, by = y + (rowH - 8)/2 - 3;
    ctx.fillStyle = "#2a2a2a";
    ctx.fillRect(bx, by, bw, 6);

    // Fill
    ctx.fillStyle = '#F25623';
    ctx.fillRect(bx, by, bw * val / 10, 6);

    // Number
    ctx.textAlign = 'right';
    ctx.font = 'bold 19px "Playfair Display", serif';
    ctx.fillStyle = '#F25623';
    ctx.fillText(val, rx + rw - 14, y + (rowH - 8)/2 + 7);

    ctx.textAlign = 'left';
    y += rowH;
  });

  y += 12;

  // Motto box
  if (data.motto) {
    ctx.strokeStyle = '#4D4D4D'; ctx.lineWidth = 1;
    ctx.strokeRect(64, y, W-128, 78);
    ctx.font = 'italic 20px "Cormorant Garamond", serif';
    ctx.fillStyle = '#888888'; ctx.textAlign = 'center'; ctx.letterSpacing = '0.5px';

    const maxW = W - 180;
    const words = `¬´${data.motto}¬ª`.split(' ');
    let line = '', lines = [];
    words.forEach(w => {
      const test = line ? line + ' ' + w : w;
      if (ctx.measureText(test).width > maxW && line) { lines.push(line); line = w; }
      else line = test;
    });
    if (line) lines.push(line);
    const lh = 26;
    const sy2 = y + 39 - ((lines.length - 1) * lh / 2);
    lines.forEach((l, li) => ctx.fillText(l, W/2, sy2 + li * lh));
    y += 92;
  }

  // Archetype block
  const arch = data.archetype;
  if (arch) {
    // Section label
    ctx.textAlign = 'left';
    ctx.font = '600 13px "Cormorant Garamond", serif';
    ctx.fillStyle = '#F25623'; ctx.letterSpacing = '4px';
    ctx.fillText('‚ú¶  –ê–†–•–ï–¢–ò–ü', 64, y);
    y += 20;

    // Arch card bg
    const archH = 140;
    ctx.fillStyle = '#1f1f1f';
    ctx.fillRect(64, y, W-128, archH);
    ctx.strokeStyle = '#F25623'; ctx.lineWidth = 2;
    ctx.strokeRect(64, y, 4, archH); // left bar

    // Glow inside
    const ag = ctx.createRadialGradient(W/2, y + archH/2, 0, W/2, y + archH/2, W*0.4);
    ag.addColorStop(0, 'rgba(242,86,35,0.1)');
    ag.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = ag;
    ctx.fillRect(64, y, W-128, archH);

    // Symbol
    ctx.font = '52px serif'; ctx.letterSpacing = '0px';
    ctx.textAlign = 'center';
    ctx.fillText(arch.symbol, W/2 - 180, y + archH/2 + 18);

    // Name
    ctx.font = 'bold 32px "Playfair Display", serif';
    ctx.fillStyle = '#F25623'; ctx.letterSpacing = '2px';
    ctx.textAlign = 'left';
    ctx.fillText(arch.name.toUpperCase(), W/2 - 110, y + 44);

    // Desc (wrap)
    ctx.font = 'italic 17px "Cormorant Garamond", serif';
    ctx.fillStyle = '#DEDEDE'; ctx.letterSpacing = '0px';
    const dWords = arch.desc.split(' ');
    let dLine = '', dLines = [];
    const dMaxW = W - 128 - (W/2 - 110) - 64 + 64;
    dWords.forEach(w => {
      const test = dLine ? dLine + ' ' + w : w;
      if (ctx.measureText(test).width > dMaxW * 0.9 && dLine) { dLines.push(dLine); dLine = w; }
      else dLine = test;
    });
    if (dLine) dLines.push(dLine);
    dLines.slice(0, 3).forEach((l, li) => ctx.fillText(l, W/2 - 110, y + 72 + li * 22));

    // Attracts
    ctx.font = '12px "Cormorant Garamond", serif';
    ctx.fillStyle = '#888'; ctx.letterSpacing = '1px';
    ctx.fillText('–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç: ' + arch.attracts.join(', '), W/2 - 110, y + archH - 18);

    y += archH + 20;
  }

  // Footer
  ctx.font = '14px "Cormorant Garamond", serif';
  ctx.fillStyle = '#4D4D4D';
  ctx.textAlign = 'center'; ctx.letterSpacing = '3px';
  ctx.fillText('SINS.APP ¬∑ ' + new Date().getFullYear(), W/2, H - 34);

  // Download
  let saved = false;
  try {
    await new Promise((resolve, reject) => {
      canvas.toBlob(blob => {
        if (!blob) { reject(new Error('no blob')); return; }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.download = `sins-${data.name.toLowerCase().replace(/\s+/g, '-')}.png`;
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 5000);
        saved = true;
        resolve();
      }, 'image/png');
    });
  } catch(e) {
    // blob failed, try dataURL
    try {
      const a = document.createElement('a');
      a.download = `sins-${data.name.toLowerCase().replace(/\s+/g,'-')}.png`;
      a.href = canvas.toDataURL('image/png');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      saved = true;
    } catch(e2) {}
  }

  if (saved) {
    showToast('‚ú¶ –ê–Ω–∫–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
  } else {
    showToast('‚ö† –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–π —Å–∫—Ä–∏–Ω—à–æ—Ç ‚Üì');
  }

  btn.disabled = false;
  btn.textContent = '‚ú¶   –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
}

// ‚îÄ‚îÄ SCREENSHOT MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function prepareScreenshot() {
  const data = getFormData();
  const card = document.getElementById('screenshot-card');

  const rows = data.order.map((id, i) => {
    const s = sinData[id];
    const v = sliderVals[id];
    const cls = i === 0 ? 'r1' : i === 1 ? 'r2' : i === 2 ? 'r3' : '';
    return `
      <div class="sc-sin-row ${cls}">
        <span class="sc-rank">${i+1}</span>
        <span class="sc-emoji">${s.emoji}</span>
        <span class="sc-sname">${s.name}</span>
        <div class="sc-bar-wrap"><div class="sc-bar" style="width:${v*10}%"></div></div>
        <span class="sc-bar-num">${v}</span>
      </div>`;
  }).join('');

  const motto = data.motto
    ? `<div class="sc-motto">¬´${data.motto}¬ª</div>` : '';

  const archBlock = data.archetype ? `
    <div class="sc-arch">
      <span class="sc-arch-sym">${data.archetype.symbol}</span>
      <div class="sc-arch-info">
        <div class="sc-arch-label">‚ú¶ –∞—Ä—Ö–µ—Ç–∏–ø</div>
        <div class="sc-arch-name">${data.archetype.name.toUpperCase()}</div>
      </div>
    </div>` : '';

  card.innerHTML = `
    <div class="sc-logo">SINS</div>
    <div class="sc-tagline">–ì—Ä–µ—à–∏—Ç—å –≤–µ—Å–µ–ª–µ–µ –≤–º–µ—Å—Ç–µ</div>
    <div class="sc-divider"></div>
    <div class="sc-name">${data.name}</div>
    <div class="sc-meta">${data.age} –ª–µ—Ç ¬∑ ${data.city} ¬∑ –ò—â–µ—Ç: ${data.seek}</div>
    <div class="sc-section-title">‚ú¶ –ú–æ–π —Å–º–µ—Ä—Ç–Ω—ã–π —Ç–æ–ø</div>
    ${rows}
    ${motto}
    ${archBlock}
    <div class="sc-footer">sins.app ¬∑ ${new Date().getFullYear()}</div>
  `;

  document.getElementById('screenshot-overlay').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeScreenshot() {
  document.getElementById('screenshot-overlay').classList.remove('active');
  document.body.style.overflow = '';
}

document.getElementById('screenshot-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeScreenshot();
});
</script>
</body>
</html>
